{% extends "../layouts/base.html" %}
{% load static %}
{% block title %}Store Settings{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>Store Settings</h2>

  <form method="POST" enctype="multipart/form-data" action="{% url 'stores:settings' %}">
    {% csrf_token %}

    <!-- Base Store Fields -->
    <div class="mb-3">
      <label class="form-label">Store Name</label>
      <input type="text" name="store_name" class="form-control" value="{{ store.name }}" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Description</label>
      <textarea name="description" class="form-control" rows="5">{{ store.description }}</textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Sheet Webhook</label>
      <input type="text" name="sheet_webhook" class="form-control" value="{{ store.sheet_webhook }}">
    </div>
    <div class="mb-3">
      <label class="form-label">Facebook Page</label>
      <input type="text" name="fb_page" class="form-control" value="{{ store.FB_PAGE }}">
    </div>
    <div class="mb-3">
      <label class="form-label">Instagram Page</label>
      <input type="text" name="insta_page" class="form-control" value="{{ store.INSTA_PAGE }}">
    </div>
    <div class="mb-3">
      <label class="form-label">Phone Number</label>
      <input type="text" name="phone_number" class="form-control" value="{{ store.PHONE_NUMBER }}">
    </div>
    <div class="mb-3">
      <label class="form-label">Email</label>
      <input type="text" name="email" class="form-control" value="{{ store.EMAIL }}">
    </div>
    <div class="mb-3">
      <label class="form-label">Whatsapp</label>
      <input type="text" name="whatsapp" class="form-control" value="{{ store.WHATSAPP }}">
    </div>
    <div class="mb-3">
      <label class="form-label">Theme Color</label>
      <input type="text" name="theme_color" class="form-control" value="{{ store.THEME_COLOR }}">
    </div>

    <div class="mb-3">
      <label class="form-label">Logo</label>
      <input type="file" name="logo" class="form-control" accept="image/*">
    </div>

    <hr>
    <h3>Facebook Pixels</h3>
    <div class="mb-3" id="pixels-container">
      <label class="form-label">Fake Pixel</label>
      <textarea name="fake_pixel" class="form-control mb-2" rows="4">{{ store.FAKE_PIXEL }}</textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Real Facebook Pixels</label>
      <div id="pixels-container">
        {% for pixel in store.pixels.all %}
          <textarea name="fb_pixels" class="form-control mb-2" rows="4">{{ pixel.pixel_code }}</textarea>
        {% empty %}
          <p class="text-muted">No pixels yet, add one below.</p>
        {% endfor %}
        <!-- one empty by default -->
        <textarea name="fb_pixels" class="form-control mb-2" rows="4" placeholder="Paste pixel code"></textarea>
      </div>
      <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-pixel-btn">+ Add Pixel</button>
      <small class="form-text text-muted d-block mt-1">
        You can add multiple pixels. Each textarea represents one pixel.
      </small>
    </div>

    <hr>
    <h3>Security</h3>
    <div class="mb-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" name="block_ref" id="block_ref"
               {% if store.block_settings.block_ref %}checked{% endif %}>
        <label class="form-check-label" for="block_ref">Block traffic source</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" name="block_ip" id="block_ip"
               {% if store.block_settings.block_ip %}checked{% endif %}>
        <label class="form-check-label" for="block_ip">Block IP</label>
      </div>
    </div>
    <hr>

    <button type="submit" class="btn btn-success mt-3">Save</button>
  </form>
</div>

<script>
document.getElementById("add-pixel-btn").addEventListener("click", function() {
  let container = document.getElementById("pixels-container");
  let textarea = document.createElement("textarea");
  textarea.name = "fb_pixels";
  textarea.className = "form-control mb-2";
  textarea.rows = 4;
  textarea.placeholder = "Paste pixel code";
  container.appendChild(textarea);
});
</script>
{% endblock %}
